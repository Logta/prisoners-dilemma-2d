# 2D Prisoner's Dilemma - 仕様書

## 1. 概要

二次元空間で囚人のジレンマゲームを実行し、遺伝的アルゴリズムによってエージェントの形質を進化させるシミュレーションアプリケーション。

## 2. 技術スタック

- Rust (ゲームロジック)
- WebAssembly
- Solid.js (UI)
- Vite (ビルドツール)
- Vitest (テストフレームワーク)
- Biome v2 (リンター/フォーマッター)

## 3. 開発方針

- t-wada が提唱する TDD を遵守
- テストが通るたびに git commit

## 4. 機能仕様

### 4.1 グリッド設定

- **サイズ**: 50x50 〜 1000x1000 (可変)
- **エージェント密度**: デフォルト 30% (可変)

### 4.2 エージェント仕様

#### 4.2.1 基本属性

- **協力確率**: 0〜100%
- **移動頻度**: 0〜100%
- **スコア**: 対戦結果の累積値

#### 4.2.2 移動

- **移動モード**: 固定/移動を切り替え可能
- **移動方法**: ランダム移動（将来的に戦略的移動を実装可能な設計）

#### 4.2.3 対戦

- **対戦範囲**: デフォルト隣接 8 マス、最大半径 5 マスまで可変
- **対戦方式**:
  - 範囲内の全エージェントと 1 回ずつ
  - 範囲内からランダムに 1 体と対戦

### 4.3 囚人のジレンマ

#### 4.3.1 利得行列（デフォルト値）

|              | 相手が協力 | 相手が裏切り |
| ------------ | ---------- | ------------ |
| 自分が協力   | (3, 3)     | (0, 5)       |
| 自分が裏切り | (5, 0)     | (1, 1)       |

※ 利得行列は変更可能

### 4.4 遺伝的アルゴリズム

#### 4.4.1 進化する形質

- 協力確率
- 移動頻度

#### 4.4.2 世代交代

- **タイミング**: 一定ターン経過後（ターン数は可変）
- **選択方法** (切り替え可能):
  - スコア上位 ○%選択
  - ルーレット選択
  - トーナメント選択

#### 4.4.3 交叉方法 (切り替え可能)

- 一点交叉
- 二点交叉
- 一様交叉

#### 4.4.4 突然変異

- **突然変異率**: 可変

### 4.5 可視化

#### 4.5.1 エージェント表示

- **色**: 協力確率に応じて色分け
- **サイズ**: スコアに応じて変化

#### 4.5.2 統計情報表示

- 平均協力率
- 最大協力率
- 最低協力率
- 協力率の標準偏差
- 平均スコア
- 最大スコア
- 最低スコア
- スコアの標準偏差
- 世代数

#### 4.5.3 グラフ表示

- 統計情報の履歴をポップアップでグラフ表示

### 4.6 その他の機能

- **実行速度調整**: シミュレーション速度を調整可能
- **プリセット機能**: 設定の保存・読み込み
- **エクスポート機能**: 結果を CSV ファイルで出力

## 5. UI 構成

### 5.1 メイン画面

- グリッド表示エリア
- コントロールパネル
  - 開始/停止/リセットボタン
  - 速度調整スライダー
- 統計情報パネル
- パラメータ設定パネル

### 5.2 設定可能パラメータ

- グリッドサイズ
- エージェント密度
- 移動モード（固定/移動）
- 対戦範囲
- 対戦方式
- 利得行列
- 世代交代ターン数
- 選択方法
- 交叉方法
- 突然変異率

## 6. データ構造（概要）

### 6.1 Agent

```rust
struct Agent {
    x: usize,
    y: usize,
    cooperation_rate: f64,
    movement_rate: f64,
    score: f64,
}
```

### 6.2 Grid

```rust
struct Grid {
    width: usize,
    height: usize,
    agents: Vec<Agent>,
}
```

### 6.3 GameConfig

```rust
struct GameConfig {
    grid_size: (usize, usize),
    agent_density: f64,
    movement_enabled: bool,
    interaction_radius: usize,
    // ... その他のパラメータ
}
```

## 7. 開発ステップ（TDD）

### Phase 1: 基本構造

1. Agent の基本構造とテスト
2. Grid の初期化とエージェント配置のテスト
3. 囚人のジレンマの利得計算テスト

### Phase 2: ゲームロジック

1. 対戦相手の検索ロジックとテスト
2. 対戦実行とスコア更新のテスト
3. エージェント移動のテスト

### Phase 3: 遺伝的アルゴリズム

1. 選択アルゴリズムのテスト
2. 交叉アルゴリズムのテスト
3. 突然変異のテスト
4. 世代交代のテスト

### Phase 4: WASM 統合

1. Rust → WASM ビルド設定
2. JavaScript/TypeScript バインディング
3. Solid.js との統合テスト

### Phase 5: UI 実装

1. グリッド表示コンポーネント
2. コントロールパネル
3. 統計情報表示
4. グラフ表示機能

### Phase 6: 追加機能

1. プリセット保存/読み込み
2. CSV エクスポート
3. パフォーマンス最適化
